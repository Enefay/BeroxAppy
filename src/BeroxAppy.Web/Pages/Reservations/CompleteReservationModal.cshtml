@page
@using BeroxAppy.Localization
@using Microsoft.AspNetCore.Mvc.Localization
@using BeroxAppy.Enums
@model BeroxAppy.Web.Pages.Reservations.CompleteReservationModalModel
@inject IHtmlLocalizer<BeroxAppyResource> L
@{
    Layout = null;
}

<abp-modal size="Large">
    <abp-modal-header title="Rezervasyonu Tamamla"></abp-modal-header>
    <abp-modal-body>
        <form id="completeReservationForm">
            <input type="hidden" id="reservationId" value="@Model.ReservationId" />

            <!-- Rezervasyon Özeti -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Rezervasyon Bilgileri</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Müşteri:</strong> @Model.Reservation.CustomerName<br />
                            <strong>Telefon:</strong> @Model.Reservation.CustomerPhone<br />
                            <strong>Tarih:</strong> @Model.Reservation.ReservationDate.ToString("dd.MM.yyyy")<br />
                            <strong>Saat:</strong> @Model.Reservation.ReservationTimeDisplay
                        </div>
                        <div class="col-md-6">
                            <strong>Toplam Tutar:</strong> <span class="h5 text-primary">₺@Model.Reservation.FinalPrice.ToString("N2")</span><br />
                            <strong>Ödenen:</strong> <span class="text-success">₺@Model.PaidAmount.ToString("N2")</span><br />
                            <strong>Kalan:</strong> <span class="text-danger">₺@Model.RemainingAmount.ToString("N2")</span><br />
                            @if (Model.CustomerDiscountRate > 0)
                            {
                                <strong>Müşteri İndirimi:</strong> <span class="text-info">%@Model.CustomerDiscountRate.ToString("N1")</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hizmet Detayları -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-list"></i> Hizmet Detayları</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Hizmet</th>
                                    <th>Çalışan</th>
                                    <th>Süre</th>
                                    <th>Fiyat (₺)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detail in Model.Reservation.ReservationDetails)
                                {
                                    <tr>
                                        <td>@detail.ServiceTitle</td>
                                        <td>@detail.EmployeeName</td>
                                        <td>@detail.DurationDisplay</td>
                                        <td>
                                            <input type="number"
                                                   class="form-control form-control-sm service-price-input"
                                                   value="@detail.ServicePrice.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)"
                                                   data-detail-id="@detail.Id"
                                                   data-original-price="@detail.ServicePrice"
                                                   min="0" step="0.01" style="width: 100px; display: inline-block;" disabled/>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Ek İndirim/Ücret -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-percentage"></i> Ek İndirim</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">İndirim Tutarı (₺)</label>
                                <input type="number" id="additionalDiscount" class="form-control"
                                       value="@((Model.Reservation.DiscountAmount ?? 0).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture))"
                                       min="0" step="0.01" />
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-plus"></i> Ek Ücret</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Ek Ücret (₺)</label>
                                <input type="number" id="additionalCharge" class="form-control"
                                       value="@((Model.Reservation.ExtraAmount ?? 0).ToString("0.00", System.Globalization.CultureInfo.InvariantCulture))"
                                       min="0" step="0.01" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Güncellenmiş Toplam -->
            <div class="alert alert-info">
                <div class="row">
                    <div class="col-md-4">
                        <strong>Hizmet Toplamı:</strong> <span id="serviceTotal">₺@Model.Reservation.TotalServicePrice.ToString("N2")</span>
                    </div>
                    <div class="col-md-4">
                        <strong>İndirim/Ek Ücret:</strong> <span id="adjustmentTotal">₺0.00</span>
                    </div>
                    <div class="col-md-4">
                        <strong>YENİ TOPLAM:</strong> <span id="finalTotal" class="h5 text-primary">₺@Model.Reservation.FinalPrice.ToString("N2")</span>
                    </div>
                </div>
            </div>

            <!-- Ödeme Bilgileri -->
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-credit-card"></i> Ödeme Bilgileri</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ödeme Tutarı (₺) <span class="text-danger">*</span></label>
                                <input type="number" id="paymentAmount" class="form-control"
                                       value="@Model.RemainingAmount"
                                       min="0" step="0.01" required />
                                <div class="form-text">Kalan tutar: ₺<span id="remainingAmount">@Model.RemainingAmount.ToString("N2")</span></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ödeme Yöntemi <span class="text-danger">*</span></label>
                                <select id="paymentMethod" class="form-select" required>
                                    <option value="">Seçiniz</option>
                                    <option value="0">Nakit</option>
                                    <option value="1">Kredi Kartı</option>
                                    <option value="2">Banka Kartı</option>
                                    <option value="3">Havale/EFT</option>
                                    <option value="4">Çek</option>
                                    <option value="5">Diğer</option>
                                </select>
                            </div>
                        </div>
                     
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ödeme Notu</label>
                        <textarea id="paymentNote" class="form-control" rows="2"
                                  placeholder="Ödeme ile ilgili notlar..."></textarea>
                    </div>

                    <!-- Tam Ödeme Yapılmadıysa Borç Uyarısı -->
                    <div id="debtWarning" class="alert alert-warning" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        Kalan tutar müşteri borcuna eklenecektir.
                    </div>
                </div>
            </div>

            <!-- Mevcut Ödemeler -->
            @if (Model.ExistingPayments.Any())
            {
                <div class="card mt-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-history"></i> Önceki Ödemeler</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Tarih</th>
                                        <th>Tutar</th>
                                        <th>Yöntem</th>
                                        <th>Açıklama</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var payment in Model.ExistingPayments)
                                    {
                                        <tr>
                                            <td>@payment.PaymentDate.ToString("dd.MM.yyyy HH:mm")</td>
                                            <td>₺@payment.Amount.ToString("N2")</td>
                                            <td>@payment.PaymentMethodDisplay</td>
                                            <td>@payment.Description</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </form>
    </abp-modal-body>
    <abp-modal-footer>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> İptal
        </button>
        <button type="button" class="btn btn-success" id="completeReservationBtn">
            <i class="fas fa-check"></i> Rezervasyonu Tamamla
        </button>
    </abp-modal-footer>
</abp-modal>
<script>
    $(function() {
        // Global değişkenler
        let originalServiceTotal = 0;

        // Sayfa yüklendiğinde değerleri al
        function initializeValues() {
            originalServiceTotal = parseFloat('@Model.Reservation.TotalServicePrice') || 0;
            calculateTotals();
        }

        // Fiyat hesaplamaları - DÜZELTİLMİŞ
        function calculateTotals() {
            // Hizmet fiyatlarını topla (değiştirilmiş olanları)
            let serviceTotal = 0;
            $('.service-price-input').each(function() {
                const value = parseFloat($(this).val()) || 0;
                serviceTotal += value;
            });

            // İndirim ve ek ücret
            const discount = parseFloat($('#additionalDiscount').val()) || 0;
            const charge = parseFloat($('#additionalCharge').val()) || 0;

            // Net ayarlama (ek ücret - indirim)
            const adjustment = charge - discount;
            const finalTotal = Math.max(0, serviceTotal + adjustment);

            // UI güncelle
            $('#serviceTotal').text('₺' + serviceTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2}));

            if (adjustment >= 0) {
                $('#adjustmentTotal').text('+₺' + adjustment.toLocaleString('tr-TR', {minimumFractionDigits: 2}));
                $('#adjustmentTotal').removeClass('text-danger').addClass('text-success');
            } else {
                $('#adjustmentTotal').text('₺' + adjustment.toLocaleString('tr-TR', {minimumFractionDigits: 2}));
                $('#adjustmentTotal').removeClass('text-success').addClass('text-danger');
            }

            $('#finalTotal').text('₺' + finalTotal.toLocaleString('tr-TR', {minimumFractionDigits: 2}));

            // Kalan tutarı hesapla
            const paidAmount = parseFloat('@Model.PaidAmount') || 0;
            const remaining = Math.max(0, finalTotal - paidAmount);

            $('#remainingAmount').text(remaining.toLocaleString('tr-TR', {minimumFractionDigits: 2}));
            $('#paymentAmount').val(remaining.toFixed(2));

            // Borç uyarısı kontrol et
            updateDebtWarning();
        }

        // Borç uyarısı güncelle
        function updateDebtWarning() {
            const remaining = parseFloat($('#remainingAmount').text().replace(/[^\d,.-]/g, '').replace(',', '.')) || 0;
            const paymentAmount = parseFloat($('#paymentAmount').val()) || 0;

            if (paymentAmount < remaining && remaining > 0) {
                $('#debtWarning').show();
                $('#paymentStatus').val('1'); // Partial
            } else {
                $('#debtWarning').hide();
                $('#paymentStatus').val('2'); // Paid
            }
        }

        // Event listeners
        $('.service-price-input, #additionalDiscount, #additionalCharge').on('input change', function() {
            calculateTotals();
        });

        $('#paymentAmount').on('input change', function() {
            updateDebtWarning();
        });

        // Rezervasyonu tamamla - DÜZELTİLMİŞ
        $('#completeReservationBtn').click(function() {
            const form = $('#completeReservationForm');
            if (!form[0].checkValidity()) {
                form[0].reportValidity();
                return;
            }

            const paymentAmount = parseFloat($('#paymentAmount').val()) || 0;
            const paymentMethod = $('#paymentMethod').val();

            if (paymentAmount > 0 && !paymentMethod) {
                abp.notify.error('Ödeme tutarı girildiğinde ödeme yöntemi seçilmelidir!');
                $('#paymentMethod').focus();
                return;
            }

            // Değişen hizmet fiyatlarını topla
            const serviceChanges = [];
            $('.service-price-input').each(function() {
                const detailId = $(this).data('detail-id');
                const newPrice = parseFloat($(this).val()) || 0;
                const originalPrice = parseFloat($(this).data('original-price')) || 0;

                // Sadece değişen fiyatları gönder
                if (Math.abs(newPrice - originalPrice) > 0.01) {
                    serviceChanges.push({
                        reservationDetailId: detailId,
                        newPrice: newPrice
                    });
                }
            });

            const data = {
                reservationId: $('#reservationId').val(),
                serviceChanges: serviceChanges,
                additionalDiscount: parseFloat($('#additionalDiscount').val()) || 0,
                additionalCharge: parseFloat($('#additionalCharge').val()) || 0,
                paymentAmount: paymentAmount,
                paymentMethod: paymentMethod ? parseInt(paymentMethod) : null,
                paymentNote: $('#paymentNote').val() || null
            };

            abp.ui.setBusy('.modal-content');

            $.ajax({
                url: '/api/app/reservation/complete-reservation',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(result) {
                abp.event.trigger('app.reservation.saved', result);
                   
                },
                error: function(xhr) {
                    const error = xhr.responseJSON?.error?.message || 'Bir hata oluştu!';
                    abp.notify.error(error);
                },
                complete: function() {
                    abp.ui.clearBusy('.modal-content');
                }
            });
        });

        // Sayfa yüklendiğinde başlat
        initializeValues();
    });
</script>